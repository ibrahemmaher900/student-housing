{% extends 'base/base.html' %}

{% block title %}{{ apartment.title }} - سكن طالب{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
<link rel="stylesheet" href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.23.0/maps/maps.css" />
<style>
    .apartment-header {
        background-color: #f8f9fa;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .apartment-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .apartment-location {
        color: #6c757d;
        margin-bottom: 1rem;
    }
    
    .apartment-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--bs-primary);
    }
    
    .apartment-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .apartment-status.available {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    
    .apartment-status.unavailable {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }
    
    .swiper {
        width: 100%;
        height: 400px;
        border-radius: 10px;
    }
    
    .swiper-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .apartment-details-card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 2rem;
        overflow: hidden;
    }
    
    .apartment-details-header {
        background-color: #f8f9fa;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
    }
    
    .apartment-details-header .icon {
        width: 40px;
        height: 40px;
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 1rem;
        color: var(--bs-primary);
        font-size: 1.2rem;
    }
    
    .apartment-details-body {
        padding: 1.5rem;
    }
    
    .apartment-features {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .apartment-feature {
        display: flex;
        align-items: center;
        background-color: #f8f9fa;
        padding: 0.5rem 1rem;
        border-radius: 50px;
    }
    
    .apartment-feature i {
        margin-left: 0.5rem;
        color: var(--bs-primary);
    }
    
    .amenities-list {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .amenity-item {
        display: flex;
        align-items: center;
        width: calc(50% - 0.5rem);
        margin-bottom: 0.5rem;
    }
    
    .amenity-item i {
        width: 30px;
        height: 30px;
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.75rem;
        color: var(--bs-primary);
    }
    
    .amenity-item.unavailable {
        color: #6c757d;
        opacity: 0.6;
    }
    
    .booking-card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        position: sticky;
        top: 2rem;
    }
    
    .booking-card-header {
        background-color: var(--bs-primary);
        color: #fff;
        padding: 1rem 1.5rem;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
    
    .booking-card-body {
        padding: 1.5rem;
    }
    
    .booking-price {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--bs-primary);
        margin-bottom: 0.5rem;
    }
    
    .owner-info {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .owner-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-left: 1rem;
    }
    
    .contact-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .contact-button {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
        border-radius: 5px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .contact-button.phone {
        background-color: #198754;
        color: #fff;
    }
    
    .contact-button.whatsapp {
        background-color: #25D366;
        color: #fff;
    }
    
    .map-container {
        height: 300px;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
{% if apartment.gender != 'all' %}
<div class="position-fixed" style="top: 80px; right: 20px; z-index: 1000;">
    {% if apartment.gender == 'male' %}
    <div class="badge bg-primary p-2 fs-6 shadow">
        <i class="fas fa-male me-1"></i> للذكور
    </div>
    {% elif apartment.gender == 'female' %}
    <div class="badge bg-danger p-2 fs-6 shadow">
        <i class="fas fa-female me-1"></i> للإناث
    </div>
    {% endif %}
</div>
{% endif %}
<!-- رأس الصفحة -->
<div class="apartment-header">
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <h1 class="apartment-title">{{ apartment.title }}</h1>
                <div class="apartment-location">
                    <i class="fas fa-map-marker-alt"></i> {{ apartment.address }}
                </div>
                <div class="d-flex align-items-center">
                    {% if apartment.get_average_rating > 0 %}
                    <div class="me-3">
                        <div class="rating-stars">
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= apartment.get_average_rating|floatformat:"0" %}
                                    <i class="fas fa-star"></i>
                                {% elif forloop.counter <= apartment.get_average_rating|add:"0.5"|floatformat:"0" %}
                                    <i class="fas fa-star-half-alt"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="rating-count">{{ apartment.get_ratings_count }} تقييم</div>
                    </div>
                    {% endif %}
                    
                    <div class="me-3">
                        <div class="views-count">
                            <i class="fas fa-eye me-1"></i> {{ apartment.views_count }} مشاهدة
                        </div>
                    </div>
                    
                    {% if apartment.available and not has_approved_booking %}
                        <div class="apartment-status available">متاح</div>
                    {% elif has_approved_booking %}
                        <div class="apartment-status booked">محجوز</div>
                    {% else %}
                        <div class="apartment-status unavailable">غير متاح</div>
                    {% endif %}
                    
                    {% if apartment.gender != 'all' %}
                    <div class="ms-2">
                        {% if apartment.gender == 'male' %}
                        <div class="badge bg-primary p-2">
                            <i class="fas fa-male me-1"></i> للذكور
                        </div>
                        {% elif apartment.gender == 'female' %}
                        <div class="badge bg-danger p-2">
                            <i class="fas fa-female me-1"></i> للإناث
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="apartment-price">
                    {{ apartment.price|floatformat:"0" }} <span class="apartment-price-period">/ شهر</span>
                </div>
                <div class="mt-2">
                    {% if user.is_authenticated %}
                        {% if is_in_wishlist %}
                            <a href="{% url 'toggle_wishlist' apartment.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-heart"></i> إزالة من المفضلة
                            </a>
                        {% else %}
                            <a href="{% url 'toggle_wishlist' apartment.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="far fa-heart"></i> إضافة للمفضلة
                            </a>
                        {% endif %}
                    {% endif %}
                    <button class="btn btn-outline-secondary btn-sm" onclick="shareApartment()">
                        <i class="fas fa-share-alt"></i> مشاركة
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- القسم الرئيسي -->
        <div class="col-lg-8">
            <!-- صور الشقة -->
            <div class="apartment-images">
                <div class="swiper">
                    <div class="swiper-wrapper">
                        {% for image in apartment.images.all %}
                            <div class="swiper-slide">
                                <img src="{{ image.image.url }}" alt="{{ apartment.title }}" class="apartment-image" onclick="openImageModal(this.src)">
                            </div>
                        {% empty %}
                            <div class="swiper-slide">
                                <img src="/static/img/default-apartment.jpg" alt="{{ apartment.title }}">
                            </div>
                        {% endfor %}
                    </div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
            </div>
            
            <!-- تفاصيل الشقة -->
            <div class="apartment-details-card">
                <div class="apartment-details-header">
                    <div class="icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h5 class="mb-0">تفاصيل الشقة</h5>
                </div>
                <div class="apartment-details-body">
                    <div class="apartment-features">
                        <div class="apartment-feature">
                            <i class="fas fa-ruler-combined"></i>
                            <span>{{ apartment.area }} م²</span>
                        </div>
                        <div class="apartment-feature">
                            <i class="fas fa-bed"></i>
                            <span>{{ apartment.bedrooms }} غرفة نوم</span>
                        </div>
                        <div class="apartment-feature">
                            <i class="fas fa-bath"></i>
                            <span>{{ apartment.bathrooms }} حمام</span>
                        </div>
                        <div class="apartment-feature">
                            <i class="fas fa-users"></i>
                            <span>{{ apartment.max_people }} أشخاص</span>
                        </div>
                        <div class="apartment-feature">
                            {% if apartment.gender == 'male' %}
                            <i class="fas fa-male"></i>
                            <span>مخصص للذكور</span>
                            {% elif apartment.gender == 'female' %}
                            <i class="fas fa-female"></i>
                            <span>مخصص للإناث</span>
                            {% else %}
                            <i class="fas fa-venus-mars"></i>
                            <span>مناسب للجميع</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <p>{{ apartment.description }}</p>
                    
                    {% if apartment.additional_description %}
                        <p>{{ apartment.additional_description }}</p>
                    {% endif %}
                    
                    <h6 class="mt-4 mb-3">المرافق والخدمات</h6>
                    <div class="amenities-list">
                        <div class="amenity-item {% if not apartment.has_wifi %}unavailable{% endif %}">
                            <i class="fas fa-wifi"></i>
                            <span>واي فاي</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_ac %}unavailable{% endif %}">
                            <i class="fas fa-snowflake"></i>
                            <span>تكييف</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_fridge %}unavailable{% endif %}">
                            <i class="fas fa-temperature-low"></i>
                            <span>ثلاجة</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_washer %}unavailable{% endif %}">
                            <i class="fas fa-tshirt"></i>
                            <span>غسالة</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_kitchen %}unavailable{% endif %}">
                            <i class="fas fa-utensils"></i>
                            <span>مطبخ</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_private_bathroom %}unavailable{% endif %}">
                            <i class="fas fa-bath"></i>
                            <span>حمام خاص</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_balcony %}unavailable{% endif %}">
                            <i class="fas fa-wind"></i>
                            <span>بلكونة</span>
                        </div>
                        <div class="amenity-item {% if not apartment.has_parking %}unavailable{% endif %}">
                            <i class="fas fa-parking"></i>
                            <span>موقف سيارات</span>
                        </div>
                    </div>
                    
                    {% if apartment.conditions %}
                        <h6 class="mt-4 mb-3">شروط السكن</h6>
                        <p>{{ apartment.conditions }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- الموقع والجامعة -->
            <div class="apartment-details-card">
                <div class="apartment-details-header">
                    <div class="icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <h5 class="mb-0">الموقع والجامعة</h5>
                </div>
                <div class="apartment-details-body">
                    <div class="university-info">
                        <img src="{{ apartment.university.get_image_url }}" alt="{{ apartment.university.name }}" class="university-logo" style="width:60px;height:60px;border-radius:10px;margin-left:1rem;">
                        <div>
                            <div style="font-weight:600;">{{ apartment.university.name }}</div>
                            <div style="font-size:0.875rem;color:#6c757d;">{{ apartment.university.city }}</div>
                        </div>
                    </div>
                    
                    <div class="distance-info" style="display:flex;flex-wrap:wrap;gap:1rem;margin-top:1rem;">
                        <div class="distance-item" style="display:flex;align-items:center;background-color:#f8f9fa;padding:0.5rem 1rem;border-radius:50px;">
                            <i class="fas fa-ruler" style="margin-left:0.5rem;color:var(--bs-primary);"></i>
                            <span>{{ apartment.distance_to_university }} كم من الجامعة</span>
                        </div>
                        {% if apartment.walking_time %}
                            <div class="distance-item" style="display:flex;align-items:center;background-color:#f8f9fa;padding:0.5rem 1rem;border-radius:50px;">
                                <i class="fas fa-walking" style="margin-left:0.5rem;color:var(--bs-primary);"></i>
                                <span>{{ apartment.walking_time }} دقيقة مشياً</span>
                            </div>
                        {% endif %}
                        {% if apartment.driving_time %}
                            <div class="distance-item" style="display:flex;align-items:center;background-color:#f8f9fa;padding:0.5rem 1rem;border-radius:50px;">
                                <i class="fas fa-car" style="margin-left:0.5rem;color:var(--bs-primary);"></i>
                                <span>{{ apartment.driving_time }} دقيقة بالسيارة</span>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="map-container mt-4" id="map-container">
                    </div>
                </div>
            </div>
            
            <!-- التقييمات -->
            <div class="ratings-section" style="margin-top:3rem;">
                <h4 class="mb-4">التقييمات ({{ ratings.count }})</h4>
                
                {% if ratings.exists %}
                    <div class="rating-summary" style="display:flex;align-items:center;margin-bottom:2rem;">
                        <div class="rating-average" style="font-size:3rem;font-weight:700;color:var(--bs-primary);margin-left:1.5rem;">
                            {{ apartment.get_average_rating }}
                        </div>
                        <div>
                            <div class="rating-stars" style="display:flex;gap:0.25rem;margin-bottom:0.5rem;">
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= apartment.get_average_rating|floatformat:"0" %}
                                        <i class="fas fa-star" style="color:#ffc107;font-size:1.2rem;"></i>
                                    {% elif forloop.counter <= apartment.get_average_rating|add:"0.5"|floatformat:"0" %}
                                        <i class="fas fa-star-half-alt" style="color:#ffc107;font-size:1.2rem;"></i>
                                    {% else %}
                                        <i class="far fa-star" style="color:#ffc107;font-size:1.2rem;"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="rating-count" style="font-size:0.875rem;color:#6c757d;">{{ ratings.count }} تقييم</div>
                        </div>
                    </div>
                    
                    <!-- توزيع التقييمات -->
                    <div class="rating-distribution" style="margin-bottom:2rem;">
                        {% for star in "54321"|make_list %}
                            <div class="rating-bar" style="display:flex;align-items:center;margin-bottom:0.5rem;">
                                <div style="width:30px;text-align:center;margin-left:0.5rem;">{{ star }}</div>
                                <i class="fas fa-star" style="color:#ffc107;margin-left:0.5rem;"></i>
                                <div class="progress" style="flex-grow:1;height:10px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" 
                                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div style="width:40px;text-align:left;margin-right:0.5rem;font-size:0.875rem;color:#6c757d;">
                                    0
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% for rating in ratings %}
                        <div class="rating-item" style="background-color:#fff;border-radius:10px;box-shadow:0 0.125rem 0.25rem rgba(0,0,0,0.075);padding:1.5rem;margin-bottom:1.5rem;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
                                <div style="display:flex;align-items:center;">
                                    <img src="{{ rating.user.profile.get_profile_picture_url }}" alt="{{ rating.user.username }}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-left:1rem;">
                                    <div>
                                        <div style="font-weight:600;">{{ rating.user.get_full_name|default:rating.user.username }}</div>
                                        <div style="font-size:0.875rem;color:#6c757d;">{{ rating.created_at|date:"j F Y" }}</div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:0.25rem;">
                                    {% for i in "12345"|make_list %}
                                        {% if forloop.counter <= rating.stars %}
                                            <i class="fas fa-star" style="color:#ffc107;"></i>
                                        {% else %}
                                            <i class="far fa-star" style="color:#ffc107;"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% if rating.review %}
                                <div style="margin-top:1rem;">
                                    {{ rating.review }}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-light text-center">
                        لا توجد تقييمات حتى الآن.
                    </div>
                {% endif %}
                
                {% if user.is_authenticated %}
                    {% if is_actual_tenant %}
                        <div class="mt-4">
                            <a href="{% url 'add_rating' apartment.id %}" class="btn btn-primary">
                                <i class="fas fa-star"></i> إضافة تقييم
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> يمكن فقط للمستأجر الفعلي للشقة إضافة تقييم
                        </div>
                    {% endif %}
                {% endif %}
            </div>
            
            <!-- التعليقات -->
            <div class="comments-section" style="margin-top:3rem;">
                <h4 class="mb-4">التعليقات ({{ comments.count }})</h4>
                
                {% if user.is_authenticated %}
                    <div class="mb-4">
                        <form method="post" action="{% url 'add_comment' apartment.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <textarea name="content" class="form-control" rows="3" placeholder="اكتب تعليقك هنا..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">إضافة تعليق</button>
                        </form>
                    </div>
                {% endif %}
                
                {% for comment in comments %}
                    {% if comment.parent is None %}
                        <div class="comment" style="background-color:#fff;border-radius:10px;box-shadow:0 0.125rem 0.25rem rgba(0,0,0,0.075);padding:1.5rem;margin-bottom:1.5rem;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
                                <div style="display:flex;align-items:center;">
                                    <img src="{{ comment.user.profile.get_profile_picture_url }}" alt="{{ comment.user.username }}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-left:1rem;">
                                    <div>
                                        <div style="font-weight:600;">{{ comment.user.get_full_name|default:comment.user.username }}</div>
                                        <div style="font-size:0.875rem;color:#6c757d;">{{ comment.created_at|date:"j F Y" }}</div>
                                    </div>
                                </div>
                                <div style="display:flex;gap:0.5rem;">
                                    {% if user.is_authenticated %}
                                        <a href="{% url 'add_reply' comment.id %}" style="color:#6c757d;font-size:0.875rem;text-decoration:none;">
                                            <i class="fas fa-reply"></i> رد
                                        </a>
                                        {% if user == comment.user or user.is_staff %}
                                            <a href="{% url 'edit_comment' comment.id %}" style="color:#6c757d;font-size:0.875rem;text-decoration:none;">
                                                <i class="fas fa-edit"></i> تعديل
                                            </a>
                                            <a href="{% url 'delete_comment' comment.id %}" style="color:#6c757d;font-size:0.875rem;text-decoration:none;" onclick="return confirm('هل أنت متأكد من حذف هذا التعليق؟')">
                                                <i class="fas fa-trash"></i> حذف
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div style="margin-bottom:1rem;">
                                {{ comment.content }}
                            </div>
                            
                            <!-- الردود -->
                            {% if comment.replies.exists %}
                                <div style="margin-top:1rem;padding-right:2rem;border-right:2px solid #e9ecef;">
                                    {% for reply in comment.replies.all %}
                                        <div style="background-color:#f8f9fa;border-radius:10px;padding:1rem;margin-bottom:1rem;">
                                            <div style="display:flex;justify-content:space-between;margin-bottom:1rem;">
                                                <div style="display:flex;align-items:center;">
                                                    <img src="{{ reply.user.profile.get_profile_picture_url }}" alt="{{ reply.user.username }}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-left:1rem;">
                                                    <div>
                                                        <div style="font-weight:600;">{{ reply.user.get_full_name|default:reply.user.username }}</div>
                                                        <div style="font-size:0.875rem;color:#6c757d;">{{ reply.created_at|date:"j F Y" }}</div>
                                                    </div>
                                                </div>
                                                <div style="display:flex;gap:0.5rem;">
                                                    {% if user == reply.user or user.is_staff %}
                                                        <a href="{% url 'edit_comment' reply.id %}" style="color:#6c757d;font-size:0.875rem;text-decoration:none;">
                                                            <i class="fas fa-edit"></i> تعديل
                                                        </a>
                                                        <a href="{% url 'delete_comment' reply.id %}" style="color:#6c757d;font-size:0.875rem;text-decoration:none;" onclick="return confirm('هل أنت متأكد من حذف هذا الرد؟')">
                                                            <i class="fas fa-trash"></i> حذف
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div>
                                                {{ reply.content }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% empty %}
                    <div class="alert alert-light text-center">
                        لا توجد تعليقات حتى الآن. كن أول من يعلق!
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- القسم الجانبي -->
        <div class="col-lg-4">
            <div class="booking-card">
                <div class="booking-card-header">
                    <h5 class="mb-0">حجز الشقة</h5>
                </div>
                <div class="booking-card-body">
                    <div class="booking-price">
                        {{ apartment.price|floatformat:"0" }} <span style="font-size:1rem;color:#6c757d;">/ شهر</span>
                    </div>
                    
                    <div style="margin:1rem 0;padding:1rem 0;border-top:1px solid #e9ecef;border-bottom:1px solid #e9ecef;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                            <div style="color:#6c757d;">طريقة الدفع</div>
                            <div style="font-weight:600;">{{ apartment.get_payment_method_display }}</div>
                        </div>
                        {% if apartment.deposit %}
                            <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                                <div style="color:#6c757d;">مبلغ التأمين</div>
                                <div style="font-weight:600;">{{ apartment.deposit|floatformat:"0" }} جنيه</div>
                            </div>
                        {% endif %}
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;">
                            <div style="color:#6c757d;">الفواتير</div>
                            <div style="font-weight:600;">
                                {% if apartment.bills_included %}
                                    شاملة الفواتير
                                {% else %}
                                    غير شاملة الفواتير
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="owner-info">
                        <img src="{{ apartment.owner.profile.get_profile_picture_url }}" alt="{{ apartment.owner.username }}" class="owner-avatar">
                        <div>
                            <div style="font-weight:600;">{{ apartment.contact_name|default:apartment.owner.get_full_name|default:apartment.owner.username }}</div>
                            <div style="font-size:0.875rem;color:#6c757d;">{{ apartment.get_advertiser_type_display }}</div>
                        </div>
                    </div>
                    
                    <div class="contact-buttons">
                        <a href="tel:{{ apartment.phone }}" class="contact-button phone">
                            <i class="fas fa-phone"></i> اتصال
                        </a>
                        {% if apartment.whatsapp_available %}
                            <a href="https://wa.me/{{ apartment.phone }}" target="_blank" class="contact-button whatsapp">
                                <i class="fab fa-whatsapp"></i> واتساب
                            </a>
                        {% endif %}
                    </div>
                    
                    {% if user.is_authenticated %}
                        {% if user == apartment.owner %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> هذه شقتك الخاصة
                            </div>
                        {% elif apartment.available and not has_approved_booking and not user_has_booking and not user_has_active_booking_elsewhere %}
                            <form method="post" action="{% url 'book_apartment' apartment.id %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label class="form-label">تاريخ البداية</label>
                                    <input type="date" name="start_date" class="form-control" min="{{ today|date:'Y-m-d' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">تاريخ النهاية</label>
                                    <input type="date" name="end_date" class="form-control" min="{{ today|date:'Y-m-d' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">رسالة للمالك (اختياري)</label>
                                    <textarea name="message" class="form-control" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">طلب حجز</button>
                            </form>
                        {% elif user_has_booking %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> لديك طلب حجز قيد المعالجة لهذه الشقة
                            </div>
                        {% elif user_has_active_booking_elsewhere %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> لديك حجز نشط في شقة أخرى
                            </div>
                        {% elif has_approved_booking %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> هذه الشقة محجوزة حالياً
                                {% if approved_booking_start and approved_booking_end %}
                                <div class="mt-2">
                                    <strong>فترة الحجز:</strong> من {{ approved_booking_start|date:"j F Y" }} إلى {{ approved_booking_end|date:"j F Y" }}
                                </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i> هذه الشقة غير متاحة للحجز حالياً
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> يرجى <a href="{% url 'login' %}?next={{ request.path }}">تسجيل الدخول</a> لحجز هذه الشقة
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
<script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.23.0/maps/maps-web.min.js"></script>
<script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.23.0/services/services-web.min.js"></script>
<script src="/static/js/ratings.js"></script>
<script>
    // تهيئة معرض الصور
    const swiper = new Swiper('.swiper', {
        loop: true,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
    });
    
    // تهيئة خريطة TomTom
    document.addEventListener('DOMContentLoaded', function() {
        const apiKey = '7bpllxbhJJfYhMPF0WfVFzyVShKdQrpq';
        
        // موقع افتراضي (القاهرة)
        let latitude = 30.0444;
        let longitude = 31.2357;
        let zoom = 13;
        
        {% if apartment.latitude and apartment.longitude %}
            latitude = {{ apartment.latitude }};
            longitude = {{ apartment.longitude }};
            zoom = 15;
        {% endif %}
        
        // إنشاء الخريطة
        const map = tt.map({
            key: apiKey,
            container: 'map-container',
            center: [longitude, latitude],
            zoom: zoom
        });
        
        // إضافة أزرار التحكم في الخريطة
        map.addControl(new tt.NavigationControl());
        map.addControl(new tt.FullscreenControl());
        
        {% if apartment.latitude and apartment.longitude %}
            // إضافة علامة على موقع الشقة
            const marker = new tt.Marker()
                .setLngLat([longitude, latitude])
                .addTo(map);
                
            // إضافة نافذة معلومات
            const popup = new tt.Popup({ offset: 30 })
                .setHTML('<strong>{{ apartment.title }}</strong><br>{{ apartment.address }}')
                .setLngLat([longitude, latitude]);
                
            marker.setPopup(popup);
            popup.addTo(map);
        {% else %}
            // البحث عن العنوان باستخدام TomTom Search API
            const searchQuery = "{{ apartment.address }}, {{ apartment.university.city }}, مصر";
            
            if (searchQuery.trim() !== ",") {
                const searchOptions = {
                    key: apiKey,
                    query: searchQuery,
                    limit: 1
                };
                
                tt.services.fuzzySearch(searchOptions)
                    .then(function(response) {
                        if (response.results && response.results.length > 0) {
                            const result = response.results[0];
                            const position = result.position;
                            
                            // تحريك الخريطة إلى الموقع المعثور عليه
                            map.flyTo({
                                center: position,
                                zoom: 15
                            });
                            
                            // إضافة علامة
                            const marker = new tt.Marker()
                                .setLngLat(position)
                                .addTo(map);
                                
                            // إضافة نافذة معلومات
                            const popup = new tt.Popup({ offset: 30 })
                                .setHTML('<strong>{{ apartment.title }}</strong><br>{{ apartment.address }}')
                                .setLngLat(position);
                                
                            marker.setPopup(popup);
                            popup.addTo(map);
                        }
                    })
                    .catch(function(error) {
                        console.error('Error searching for address:', error);
                    });
            }
        {% endif %}
    });
    
    // مشاركة الشقة
    function shareApartment() {
        if (navigator.share) {
            navigator.share({
                title: '{{ apartment.title }}',
                text: 'شاهد هذه الشقة على موقع سكن طالب',
                url: window.location.href
            })
            .catch(error => console.log('Error sharing:', error));
        } else {
            // نسخ الرابط إلى الحافظة
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = window.location.href;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
            
            alert('تم نسخ الرابط إلى الحافظة');
        }
    }
    
    // التحقق من صحة نموذج الحجز
    document.addEventListener('DOMContentLoaded', function() {
        const bookingForm = document.querySelector('form[action*="book_apartment"]');
        if (bookingForm) {
            const startDateInput = bookingForm.querySelector('input[name="start_date"]');
            const endDateInput = bookingForm.querySelector('input[name="end_date"]');
            
            // تحديث الحد الأدنى لتاريخ النهاية عند تغيير تاريخ البداية
            startDateInput.addEventListener('change', function() {
                if (this.value) {
                    // تعيين الحد الأدنى لتاريخ النهاية ليكون بعد تاريخ البداية بيوم واحد على الأقل
                    const nextDay = new Date(this.value);
                    nextDay.setDate(nextDay.getDate() + 1);
                    
                    // تنسيق التاريخ بالصيغة YYYY-MM-DD
                    const year = nextDay.getFullYear();
                    const month = String(nextDay.getMonth() + 1).padStart(2, '0');
                    const day = String(nextDay.getDate()).padStart(2, '0');
                    
                    endDateInput.min = `${year}-${month}-${day}`;
                    
                    // إذا كان تاريخ النهاية قبل تاريخ البداية الجديد، قم بتحديثه
                    if (endDateInput.value && new Date(endDateInput.value) <= new Date(this.value)) {
                        endDateInput.value = `${year}-${month}-${day}`;
                    }
                }
            });
            
            // التحقق من صحة النموذج عند الإرسال
            bookingForm.addEventListener('submit', function(e) {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                const today = new Date();
                
                today.setHours(0, 0, 0, 0);
                
                if (startDate < today) {
                    e.preventDefault();
                    alert('لا يمكن اختيار تاريخ بداية في الماضي');
                    return false;
                }
                
                if (endDate <= startDate) {
                    e.preventDefault();
                    alert('يجب أن يكون تاريخ النهاية بعد تاريخ البداية');
                    return false;
                }
                
                // التحقق من أن مدة الحجز لا تقل عن شهر
                const oneMonth = 30 * 24 * 60 * 60 * 1000; // شهر بالملي ثانية
                if (endDate - startDate < oneMonth) {
                    e.preventDefault();
                    alert('يجب أن تكون مدة الحجز شهر على الأقل');
                    return false;
                }
                
                return true;
            });
        }
    });
</script>
{% endblock %}